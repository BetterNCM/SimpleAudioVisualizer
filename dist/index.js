(()=>{function x(d){let t=d*d;return 1.2588966*14884e4*t*t/((t+424.36)*Math.sqrt((t+11599.29)*(t+544496.41))*(t+14884e4))}function W(d,t=1,e=0){return Math.pow(Math.E,-(Math.pow(d-e,2)/(2*t*t)))}var y=class{constructor(t={}){let{filterParams:e,sampleRate:s,fftSize:i,endFrequency:o,startFrequency:n,outBandsQty:r,tWeight:a,aWeight:p}=t;if(!i||!s||!r)throw new Error("need fftSize, sampleRate and outBandsQty");this.sampleRate=s,this.fftSize=i||1024,this.bandsQty=Math.floor(i/2),this.outBandsQty=r,this.bandwidth=s/i,this.startFrequency=n||0,this.endFrequency=o||1e4,this.tWeight=!!a,this.aWeight=p===void 0?!0:!!p,e&&(this.filterParams={mu:0,sigma:e.sigma||1,filterRadius:e.radius===void 0?2:Math.floor(e.radius)}),this.aWeights=[],this.bands=[],this.gKernel=[],this.historyLimit=5,this.history=[],this.initWeights(),this.initBands(),this.initGaussKernel(),this.process=this.process.bind(this)}initWeights(){let{bandwidth:t,bandsQty:e,aWeights:s}=this;for(let i=0;i<e;i++)s.push(x(i*t))}initBands(){let{endFrequency:t,startFrequency:e,outBandsQty:s,bands:i}=this,o=Math.log2(t/e)/s;o=Math.pow(2,o);let n={lowerFrequency:Math.max(e,0),upperFrequency:0};for(let r=0;r<s;r++){let a=n.lowerFrequency*o;n.upperFrequency=Math.min(a,t),i.push({lowerFrequency:n.lowerFrequency,upperFrequency:n.upperFrequency}),n.lowerFrequency=a}}initGaussKernel(){let{filterParams:t,gKernel:e}=this,{mu:s,sigma:i,filterRadius:o}=t,n=o;for(let r=-n;r<1;r++)e.push(W(r,i,s));for(let r=n-1;r>-1;r--)e.push(e[r]);this.gKernelSum=e.reduce((r,a)=>r+a),this.filterRadius=o,console.log(e)}filter(t){let{gKernel:e,gKernelSum:s,filterRadius:i}=this;if(i)for(let o=0;o<t.length;o++){let n=0;for(let r=o-i;r<o+i;r++){let a=t[r]!==void 0?t[r]:0;n+=a*e[r-o+i]}t[o]=n/s}}aWeighting(t){let{aWeights:e}=this;for(let s=0;s<t.length;s++)e[s]!==void 0&&(t[s]=t[s]*e[s])}divide(t){let{outBandsQty:e,bandwidth:s,bands:i}=this,o=new Array(e);for(let n=0;n<i.length;n++){let r=i[n],a=Math.floor(r.lowerFrequency/s),p=Math.min(Math.floor(r.upperFrequency/s),t.length-1),w=0;for(let l=a;l<=p;l++)w+=t[l]*t[l];o[n]=Math.sqrt(w/(p+1-a))}return o}timeWeighting(t){let{history:e,historyLimit:s}=this;if(e.length<5)e.push(t.slice(0));else{e.pop(),e.unshift(t.slice(0));for(let i=0;i<t.length;i++){let o=0;for(let n=0;n<s;n++)o+=e[n][i]/s;t[i]=o}}}process(t){return this.filterParams&&this.filter(t),this.tWeight&&this.timeWeighting(t),this.aWeight&&this.aWeighting(t),this.divide(t)}};var F=class{constructor(t,e,s){this.x=t,this.y=e,this.w=s,this.opacity=.3,this.smoother=.3}update(t){let{smoother:e,lastF:s}=this,o=.3+.7*(s!==void 0?s:t)/255,n=.3+.7*t/255;this.opacity=e*o+(1-e)*n,this.lastF=t}draw(t){let{opacity:e,x:s,y:i,w:o}=this,n=o/2;t.fillStyle=`hsla(${360*e}, 50%, 50%, ${e})`,t.beginPath(),t.arc(s+n,i+n,o*e/2,0,2*Math.PI),t.closePath(),t.fill()}},m=F;var b=class{constructor(t,e,s,i){this.x=t,this.y=e,this.w=s,this.h=i,this.bottom=i+e,this.opacity=.3,this.smoother=0}update(t){let{smoother:e,last:s}=this,o=.05+.95*(s!==void 0?s:t)/255,n=.05+.95*t/255;this.opacity=e*o+(1-e)*n,this.last=t}draw(t){let{opacity:e,x:s,w:i,h:o,bottom:n}=this,r=n-o*e;t.fillStyle=`hsla(4, ${80*e}%, 51%, ${e})`,t.beginPath(),t.rect(s,r,i,o*e),t.closePath(),t.fill()}},v=b;var B=9,C=81,A=class{constructor(t,e){let s=window.getComputedStyle(t),i=this.ratio=window.devicePixelRatio||1;t.width=parseFloat(s.width,10)*i,t.height=parseFloat(s.height,10)*i,this.ctx=t.getContext("2d"),this.ctx.fillStyle="rgba(255,255,255,0.5)",this.ctx.lineJoin="round",this.ctx.lineWidth=20,this.canvas=t,this.targets=[],this.draw=this.draw.bind(this),e?e===1?this.initSquares():typeof e=="object"&&(this.target=e):this.initBars()}initBars(){let t=C,e=5,{width:s,height:i}=this.canvas,o=(s-e*t-e)/t,n=300,r=i-n;for(let a=0;a<t;a++){let p=o*a+(a+1)*e;this.targets.push(new v(p,r,o,n))}this.draw()}initSquares(){let t=B,e=40*this.ratio,s=Math.floor(t/2),{width:i,height:o}=this.canvas,n=Math.min(Math.min(i,o)/(1.5*t+1.5),e),r=(i-(1.5*t-.5)*n)/2,a=(o-(1.5*t-.5)*n)/2,p=1.5*n*s+r,w=1.5*n*s+a;for(let l=0;l<s;l++){let c=p+1.5*n*l,g=w+1.5*n*l;this.targets.push(new m(c,g,n)),c+=1.5*n,this.targets.push(new m(c,g,n));for(let u=1;u<=l*2+1;u++)g-=1.5*n,this.targets.push(new m(c,g,n));for(let u=1;u<=l*2+2;u++)c-=1.5*n,this.targets.push(new m(c,g,n));for(let u=1;u<=l*2+2;u++)g+=1.5*n,this.targets.push(new m(c,g,n));for(let u=1;u<=l*2+1;u++)c+=1.5*n,this.targets.push(new m(c,g,n));l===s-1&&(c+=1.5*n,this.targets.push(new m(c,g,n)))}this.draw()}update(t){let{targets:e,target:s}=this;if(s){let i=.9+t[0]/255;s.style.transform=`scale(${i})`,s.style.opacity=`${.3+t[0]/255}`}else{for(let i=0;i<e.length;i++)t[i]!==void 0&&e[i].update(t[i]);this.draw()}}draw(){let{ctx:t,targets:e}=this,s=e.length;t.clearRect(0,0,this.canvas.width,this.canvas.height);for(let i=0;i<s;i++)e[i].draw(t)}},P=A;var E=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,R=1024,Q=150,K=4500,T=81,M=class{constructor(t,e){t&&this.setAudio(t),this.AC=new E,this.analyser=this.AC.createAnalyser(),this.analyser.fftSize=R,this.vc=new P(document.querySelector("#canvas"),e),this.refreshFrame=this.refreshFrame.bind(this),this.setAudio=this.setAudio.bind(this)}setAudio(t,e){if(!t){console.error("need a audio dom");return}let{AC:s,analyser:i}=this;this.audio=t,s.createMediaElementSource(this.audio).connect(i),i.connect(s.destination),console.log("audio context",s),console.log("analyser",i),t.addEventListener("end",this.pause),this.soundProcessor=new y({filterParams:{sigma:1,radius:2},sampleRate:s.sampleRate,fftSize:R,endFrequency:K,startFrequency:e===2?1e3:Q,outBandsQty:e===2?1:T,tWeight:!0,aWeight:!0}),console.log("soundProcessor",this.soundProcessor)}play(){this.audio&&this.audio.paused?this.AC.resume().then(()=>{this.audio.play(),this.paused=!1,this.refreshFrame()}).catch(t=>{console.log("eeee",t)}):(this.audio.pause(),this.paused=!0)}pause(){this.audio&&!this.audio.paused&&(this.audio.pause(),this.paused=!0)}refreshFrame(){let t=this.getFre();this.vc.update(t),this.paused||window.requestAnimationFrame(this.refreshFrame)}getFre(){let{analyser:t,soundProcessor:e}=this,s=new Uint8Array(t.frequencyBinCount);return t.getByteFrequencyData(s),e.process(s)}},q=M;var S;plugin.onLoad(d=>{S=document.createElement("div"),ReactDOM.render(h(I,null),S),betterncm.utils.waitForElement("#main-player").then(t=>{let e=document.createElement("canvas");t.appendChild(e),e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.right="0",e.style.botton="0";let s=new q})});function I(){return h(f,null,h("canvas",{id:"canvas"}))}plugin.onConfig(()=>S);})();
